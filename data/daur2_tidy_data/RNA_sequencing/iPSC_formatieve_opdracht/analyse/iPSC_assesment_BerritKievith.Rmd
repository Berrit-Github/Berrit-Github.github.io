---
title: "iPSC assement"
author: "Berrit Kievith"
output: html_document
---


Stam cellen zijn cellen die zich kunnen omvormen tot elk cel type en spelen een belangrijke rol bij de ontwikkeling. Volwassen hebben minder felxibele stamcellen dan embyos deze kunnen zich niet meer tot elke cel vormen.
bij sommige ziektes kunnen stamcellen helpen de patiënt te genezen. hierbij worden het liefst stamcellen van de persoon zelf gebruikt om afstoting te voorkomen. Helaas zijn de stamcellen van volwassen hier niet geschikt voor. een oplossing is het maken van geïnduceerde pluripotente stamcellen (iPSC) deze stamcellen worden gemaakt uit al gedifrentieerde cellen van de persoon.
Om te zorgen dat de cellen terug diffrentieren worden er 4 transcriptie factoren tot over expressie gebracht. (MYC, OCT3/4, SOX2 en KLF4).
In deze studie wordt bekeken wat de verschillen zijn in genesxpressie tussen fibroblasten en de bijbehorende iPSC. hiervoor wordt gebruik gemaakt van RNA-sequencing


```{bash download fastq (opdracht 1b), eval=FALSE }
# script voor het downloaden van de FastQC files naar de daarvoor bestemde map
# dit is een voorbeeld de fastQ data is al gedownload en staat in  /home/daur2/rnaseq/rnaseq_ipsc/fastq/
#!/bin/bash

for files in $(cat indentifiers.txt)
do 

fastq-dump --split-3 --outdir '/home/berrit.kievith/daur2/les1/fastq_files/.' --gzip $files

done

```

De FastQC html files werden bekeken hieruit werd geconcludeerd dat: de kwaliteit scores over alle bases en de kwaliteit score van de sequentie zijn hoog en zijn goed genoeg om mee te werken.

de reads uit de FastQC files werd vervolgens gealigned met het referentie genoom hg38

```{r alignment van fragmenten met genoom (opdracht 1c), eval=FALSE}
# eerst werd het referentie genoom gedownload en unzipped.
# dit is een voorbeeld het referentie genoom is al gedownload en staat in /home/daur2/rnaseq/hg38_genome/

wget -P './hg38_genome/' https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_39/GRCh38.primary_assembly.genome.fa.gz

gunzip ./hg38_genome/*.fa.gz

#vervolgens werd er een index gemaakt van het referentie genoom
# wordt gedaan omdat de mapping softwarde niet werkt met het gedownloade referentie genoom.

install.packages("BiocManager")
BiocManager::install("Rsubread")
library(Rsubread)

hg38_index <- "/home/daur2/rnaseq/hg38_index"
  
hg38_ref <- "/home/daur2/rnaseq/hg38_genome/GRCh38.primary_assembly.genome.fa"
#index maken van het hg38 genoom
ispc_hg38_index <- buildindex(basename = hg38_index , refrence = hg38_ref, gappedindex = FALSE, indexplit = FALSE)

#vervolgens werd de alginment uitgevoerd daarvoor waren er 3 vectors nodig hieronder zijn deze uitgevoerd
# dit is een voorbeeld de aligment is al uitgevoerd en staat in /home/daur2/rnaseq/hg38_index/

#een object maken met de locaties van de fastQ files
iSPC_fastQ_loc <- '/home/berrit.kievith/daur2/les1/fastq_files/'

#maak een object met de locatie voor de output files 
iSPC_bam_loc <- '/home/berrit.kievith/daur2/les1/bam_files/'

#maak een vector met de nummers van de fastQ files 
sample_namen <- list.files(iSPC_fastQ_loc, pattern = "_[12].fastq.gz") %>% 
  str_remove(pattern = "_[12].fastq.gz") %>%
  unique()

# nu kan fastQ files aligned worden met de hg38 genoom, omdat het een stranded protocol is worden de forward en de reverse gescheiden als readfile1 en readfile2 met als filter de _[12].fastqz.gz, het is RNA , we willen alleen weten hoeveel unieke reads van de files zich op het genoom bevinden hiervoor gebruiken we unique = TRUE
iSPC_alignment_statistics <- align(
  index = ispc_hg38_index,
  readfile1 = paste0(iSPC_fastQ_loc, sample_namen, "_1.fastq.gz"), 
  readfile2 = paste0(iSPC_fastQ_loc, sample_namen, "_2.fastq.gz"),
  type = "rna", input_format = "gzFASTQ", output_format = "BAM",
  output_file = paste0(iSPC_bam_loc, sample_namen, ".bam"), 
  unique = TRUE,
  nthreads = 10)


#als laatst wordt de alifnment opgeslagen als een RDS file in R
saveRDS(iSPC_alignment_statistics, file = paste0(iSPC_bam_loc, "iSPC_alignment_statistics.rds"))

```

van deze alginment werden het percentage mapped reads uitgezet in een grafiek.

```{r percantage mapped (opd 1e), message = FALSE}
library(tidyverse)
#eerst word het RDS van de algiment ingeleven en omgezet naar een tibble daarbij wordt er 2 extra kolomen ingplaatsd 1 met het percentage unieke reads die wel terug kwamen op het genoom en een die met het percentage die niet terug kwamen op het genoom
alignment_statistics <- readRDS('/home/daur2/rnaseq/rnaseq_ipsc/bam/alignment_statistics.rds')
alignment_stats_t <- alignment_statistics %>% 
  t ()%>% 
  as_tibble() %>% 
  mutate(bamfile=colnames(alignment_statistics)) 
new_aligment <- alignment_stats_t %>% mutate(percentage_unmapped_fragments = round(Unmapped_fragments /Total_fragments*100, digits = 4)) %>% mutate(percentage_mapped_fragments = round(Mapped_fragments /Total_fragments*100, digits = 4)) 

#De alignment data wordt tidy gemaakt om zo makelijker met de data te kunnen werken.
separate_prc_alignment <- new_aligment %>% pivot_longer(cols = c("percentage_unmapped_fragments" , "percentage_mapped_fragments" ), names_to = "un_or_maped" , values_to = "percentage")

#het maken van de plot
ggplot(data = separate_prc_alignment, aes(x = bamfile , y = percentage ,fill = un_or_maped)) + geom_col() + labs(title = "percentage mapped en unmapped fragmenten per bamfile") +theme(axis.text.x = element_text(angle = 90)) + guides(fill=guide_legend("legenda"))


```
van de samples SRR7866687 en SRR7866691 komen meer dan 20% van de unieke reads niet overeen met het referentie genoom.

Van de data werd vervolgens een count tabel gemaakt dit laat zien hoevaak de reads terug komen. (sequencing depth)

```{r making count table(opd 2a) , eval=FALSE}
library(Rsubread)

# dit is een voorbeeld het de count tabel is al gegenereerd en staat in  /home/daur2/rnaseq/rnaseq_ipsc/counts/

# maak een vector met de locatie van de bam files
iSPC_bam_loc <- '/home/berrit.kievith/daur2/les1/bam_files/'

# maak een vector met de locatie voor de output count tabel
counts_dir <- "/home/berrit.kievith/daur2/les1/counts/"

#maak een vector met de namen van de bam files
bam_files <- list.files(iSPC_bam_loc, pattern = ".*\\.bam$", full.names = TRUE)

# maak de count tabel. hierin het aantal reads per gen geteld. die wordt gedaan met behulp van de de ingbouwde NCBI referentie gebruitk voor het menselijk genoom "hg38", files zijn gepaard dus isPairedEnd = true, er is een stranded protocol gebruitk dus strandspecific = 1.
ipsc_counts <- featureCounts(
  
  files = iSPC_bam_loc,
  annot.inbuilt = "hg38",
  useMetaFeatures = TRUE,
  strandSpecific = 1,
  isPairedEnd = TRUE, 
  countReadPairs = TRUE, 
  nthreads = 10,
  reportReadsPath = counts_dir
)



```
Van de counts van de reads werd bekeken hoevaak deze terug gevonden konden worden op het referentie genoom.

```{r percentage assigned reads plot (2b)}
#de count tabel wer geimporteerd
ispc_counts <- read_rds("/home/daur2/rnaseq/rnaseq_ipsc/counts/read_counts.rds")
# de stats van de tabel werden apart gezet en de eerst kolom werd omgevormd zodat er rijnamen werden gevormd
ispc_counts_stats <- ispc_counts$stat
rownames(ispc_counts_stats) <- ispc_counts_stats$Status
ispc_counts_stats$Status <- NULL

# de nieuwe tabel werd omgevormd tot een tibble en er werden 3 nieuwe rijen toegevoegd, 1 met de namen van de bamfiles, 2 met het totale aantal counts doormiddel van colSums functie, 1 met het percentage assigned reads door de assigned reads te delen door het totaal.

ispc_counts_stats_tibble <- ispc_counts_stats %>% 
  t %>% 
  as_tibble() %>% 
  mutate(bamfile=colnames(ispc_counts_stats)) %>%
  mutate(Total=colSums(ispc_counts_stats)) %>%
  mutate(perc_assigned = Assigned/Total*100)

#van deze tibble werd vervolgens een tabel gemaakt met daarin het percentage van de read count dat werd terug gevonden op het genoom.

ispc_counts_stats_tibble %>% ggplot(aes(x = bamfile , y = perc_assigned)) + 
  geom_col() +
  labs(title = "percentage assigned reads" , x = "bamfile" , y = "percentage assigned reads") +
  theme(axis.text.x = element_text(angle = 90)) +
  coord_cartesian(ylim = c(1,100))
```
van de samples SRR7866687 en SRR7866691 komen veel counts niet terug op het referentie genoom. dit is te verklaren omdat een deel van de unieke reads niet voor kwamen op het referentie genoom.
Het percentage assigend counts is voor alle filles lager dan 70%.

```{r DEseq2 object (2c), message = FALSE, warning= FALSE}
library(DESeq2)
BiocManager::install("DESeq2")
#van de count tabel werd de count matrix uit de count tabel apart gehaald.
ispc_count_matrix <- ispc_counts$counts

# daarna werd de sample data geinporteerd en naar een data frame omgezet, met rijnamen
ispc_metadata <- read_csv('/home/daur2/rnaseq/rnaseq_ipsc/ipsc_sampledata.csv')
ispc_metadata <- as.data.frame(ispc_metadata)
rownames(ispc_metadata) <- paste0(ispc_metadata$Run, ".bam")

# check of de namen van de countmatrix over een komen met die van de dataframe
colnames(ispc_count_matrix) == rownames(ispc_metadata)

# er werd een kolom toegevoegd waarin iedere test conditie werd opgedeeld in fibroblasten en iPSC's vervolgens werden deze met de factor zo ingesteld dat de firoblasten als baseline worden gebruikt en de iPSC data wordt hiermee vergeleken.
ispc_metadata <- ispc_metadata %>% mutate(cell_lijn = str_replace(Cell_type, "Skin derived fibroblast", "fibroblast"))
ispc_metadata$cell_lijn <- ispc_metadata$cell_lijn %>% factor(levels = c("fibroblast", "iPSC"))

#de DESeq data set wordt gemaakt afgekort dds. 
ispc_dds <- DESeqDataSetFromMatrix(
  countData = ispc_count_matrix,
  colData = ispc_metadata, 
  design = ~ cell_lijn
)

```


```{r plot percentage overeenkomst genen (2d) , message = FALSE}

#eerst wordt de data van de dds genormaliseerd met de speciale log2 functie die speciefiek is voor RNA uit het DESeq2 packkage (rlog)
ispc_dds_normalized <- rlog(ispc_dds)

#er zijn veel genen aanwezig in de data om deze allemaal individueel te vergelijken is veel werk daarom maten we een summary met de principal components analysis. hierbij wordt de variatie van genen opgedeeld in een aantal stukken stukken.
ispc_pca <- ispc_dds_normalized %>% assay() %>% t() %>% prcomp()
ispc_pca_summary <- summary(ispc_pca)$importance
ispc_pca_plotting <- cbind(ispc_metadata, ispc_pca$x)

# we pakken de percentages van de variatie stukken 1 en 2 
PC1_var <- round(ispc_pca_summary["Proportion of Variance", "PC1"]*100, digits = 1)
PC2_var <- round(ispc_pca_summary["Proportion of Variance", "PC2"]*100, digits = 1)

# vervolgens plotten we deze stukken tegen elkaar uit
ggplot(ispc_pca_plotting) + 
  geom_point(aes(x=PC1, y=PC2, color = Cell_type, shape =source_name ), size = 5) +
  ggtitle("PCA for iPSC study") +
  xlab(paste0("PC1 (", PC1_var, "%)")) +
  ylab(paste0("PC2 (", PC2_var, "%)")) +
  theme_bw()


```

PC1 laat 82% van de variatie in de genen zien. hier in zien we dat de iPSC van de fibroblasten worden gescheiden. Dit klopt omdat door de behandeling een andere regulatie van genen komt. daarnaast laat PC2 6% van de variatie zien. hierdoor worden de vibroblasten van elkaar gescheiden het is bekend op basis waarvan dit gebeurt.

```{r heatmap van correlatieco van de samples (opd 2e)}
# de matrix van de dds genormalizeerde data wordt in een aparte vector gezet, hiervan worden de correlatie coefficient tussen de verschillende samples berekend
ispc_dds_norm <- assay(ispc_dds_normalized)
ispc_cor <- cor(ispc_dds_norm)
#de correlatie wordt uitgeplot in een heatmap.
library(pheatmap)
pheatmap(ispc_cor, annotation = ispc_metadata["cell_lijn"])
```

de iPCS (91-94.bam) hebben grote overeenkomsten met elkaar. De fibroblasten (87-90.bam) hebben ook een grote overeenkomsten met elkaar. Er is een lage correlatie tussen de fibroblasten en iPSC cellen. Het punt hierbij is wel dat als er wordt gekeken naar de verschillen in de correlatie coefficiënt is deze maar tussen 0.99 en 0.93 deze verschillen zijn dus niet heel groot.

```{r DGE analyse en reultaat, message = FALSE}
#differential gen expressie analyse, deze analyse wordt uitgevoerd met de DESeq functie. vervolgens werden de resultaten gefilterd of ze significant waren pvalue = <0.05 en of de fold change meer was dan 1 /-1 hiervan werd de samenvatting gegeven.
ispc_dge <- DESeq(ispc_dds)
results_ispc_dge <- results(ispc_dge, lfcThreshold = 1, alpha = 0.05)
summary(results_ispc_dge)

```

![airway summary ](figures/airway_summary.PNG)

er zijn meer up en down regulated genes in de ISPC study dan in de airway study. er zijn wel meer genenes met een low count 25%

```{r volcano plot valid foldchange (opd 3b) }
#eerst werd er een data frame gemaakt van de resuktaten van de ispc en de NA resultaten werden verwijderd. vervolgens werd er een extra kolom toegevoegd die laat zien welke van de rows voldoen aan een padj <0.05 en of de fold change >1/<-1
library(tidyverse)
ispc_dge_plotting <- data.frame(results_ispc_dge) %>% filter(!is.na(padj))

ispc_dge_plotting <- ispc_dge_plotting %>% 
  mutate(valid = if_else(padj < 0.05 & abs(log2FoldChange)  >1 , "validP", "not_valid"))

#de nieuwe vector werd uitgeplot de genen die voldeden aan padj <0.05 en of de fold change >1/<-1 werden donker blauw gekleurd.
ispc_dge_plotting %>% 
  ggplot(aes(x = log2FoldChange, y = -log10(padj), color = valid)) +
  geom_point() + 
  xlab("log2 fold change") +
  ylab("-log10 adjusted p-value") + 
  theme_bw() + scale_colour_manual(values = c("grey", "darkblue"), name = "Significance")+
  geom_hline(yintercept = -log10(0.05), linetype = "dashed")+
  geom_vline(xintercept =  1, linetype = "dashed")+
   geom_vline(xintercept =  -1, linetype = "dashed")


```



```{r high fold change heatmap (3c)}
#om een heatmap te maken van de genen met de hoogste fold change (positief of neagtief) werd de data eerst gefilterd. voor de rijnamen
library(pheatmap)
high_LFC_gene_names <- results_ispc_dge %>% as.data.frame() %>% filter(padj <0.05)
high_LFC_rownames <- rownames(high_LFC_gene_names[order(abs(high_LFC_gene_names$log2FoldChange ))[1:15],])
#we pakken de count data van de genen die we hierboven hebben geselecteerd
count_values_highLFC <- assay(ispc_dds)[high_LFC_rownames,]
#vervang de kolom namen zodat de namen speciefiek zijn per sample
colnames(count_values_highLFC)<- colData(ispc_dds)$source_name
#map de resultaten uit gebruik scaling om beter te zien wat de verschillen zijn tussen de data
pheatmap(count_values_highLFC, show_rownames = TRUE, scale = "row" )

```


```{r heatmap met namen van genen (opd 4a), message = FALSE , warning= FALSE}

BiocManager::install("org.Hs.eg.db")
library("org.Hs.eg.db")
#eerst word de coutn values omgezet naar een dataframe
new_heath_map_data <- count_values_highLFC %>% data.frame()
#er wordt een nieuwe kolom toegevoegd die de gen nummers heeft daarna wordt er op die nummers het gen symbol toegevoegd in een nieuwe kolom met de mapIds functie
new_heath_map_data<- mutate(new_heath_map_data, entrized = rownames(new_heath_map_data))

new_heath_map_data$symbol <- mapIds(org.Hs.eg.db,
                                    keys = new_heath_map_data$entrized,
                                    column = "SYMBOL",
                                    keytype = "ENTREZID",
                                    multiVals = "first")
#vervolgens vervangen we de roenames met de symbol namen en voeren de mapping opnieuw uit.
rownames(count_values_highLFC) <- new_heath_map_data$symbol
pheatmap(count_values_highLFC, show_rownames = TRUE, scale = "row" )


```



```{r hyper function (4b), message = FALSE}
#functie voor het automaties maken van een GOtermAnalasis

library(GOstats)
library(GO.db)

gotermAnalysis <- function(DEseq_results, upregulated, LFC , Pvalue){
  all_names <- DEseq_results %>% data.frame() %>% rownames()
 
         if(upregulated == TRUE) { DEseq_new_filter<- DEseq_results %>% data.frame() %>% filter(log2FoldChange > LFC, padj < Pvalue) %>%rownames()
           } else if (upregulated == FALSE){ DEseq_new_filter<- DEseq_results %>% data.frame() %>%  filter(log2FoldChange < -LFC, padj < Pvalue) %>%rownames()   
    } else {return("NO")}
  
  test_object <- methods::new("GOHyperGParams",
                     geneIds = DEseq_new_filter,
                     universeGeneIds = all_names, 
                     annotation = "org.Hs.eg.db", 
                     ontology = "BP", 
                     pvalueCutoff = 1,
                     testDirection = "over")
  goterm_analysis <- hyperGTest(test_object)
  summary(goterm_analysis)
  
  
}
```


```{r upregulated gene plot (4c)}

goterm_up_analysis_results <- gotermAnalysis(results_ispc_dge, upregulated = TRUE , 1 , 0.01)

goterm_up_analysis_results$padj <- p.adjust(goterm_up_analysis_results$Pvalue, method = "BH")

goterm_up_analysis_results <- goterm_up_analysis_results %>% filter(Count > 5) %>% filter(Count < 500)


goterm_up_analysis_top15 <- goterm_up_analysis_results[order(goterm_up_analysis_results$padj)[1:15],]
goterm_up_analysis_top15$Term <- factor(goterm_up_analysis_top15$Term, 
                                     levels = goterm_up_analysis_top15$Term[
                                       order(goterm_up_analysis_top15$padj, decreasing = TRUE)])

goterm_up_analysis_top15 %>% ggplot(aes(x = Term, y = -log10(padj))) +
  geom_point() +
  coord_flip() +
  ylab(expression(-log[10](adjusted~italic(P)~value))) + 
  xlab("GO terms") +
  ggtitle(" top 15 upregulated genes with GO terms") +
  theme_bw()


```


```{r down regulated gene plot (4b)}

goterm_down_analysis_results <- gotermAnalysis(results_ispc_dge, upregulated = FALSE , 1 , 0.01)

goterm_down_analysis_results$padj <- p.adjust(goterm_down_analysis_results$Pvalue, method = "BH")

goterm_down_analysis_results <- goterm_down_analysis_results %>% filter(Count > 5) %>% filter(Count < 500)


goterm_down_analysis_top15 <- goterm_down_analysis_results[order(goterm_down_analysis_results$padj)[1:15],]
goterm_down_analysis_top15$Term <- factor(goterm_down_analysis_top15$Term, 
                                        levels = goterm_down_analysis_top15$Term[
                                          order(goterm_down_analysis_top15$padj, decreasing = TRUE)])

goterm_down_analysis_top15 %>% ggplot(aes(x = Term, y = -log10(padj))) +
  geom_point() +
  coord_flip() +
  ylab(expression(-log[10](adjusted~italic(P)~value))) + 
  xlab("GO terms") +
  ggtitle(" top 15 downregulated genes with GO terms") +
  theme_bw()

```

In de grafieken zijn de 15 genen te zien die in de iSPC cellen zijn up en down gereguleerd, ten opzichten van de fibroblasten. 
Genen die te maken hwbben celmigratie en vorming van bloedvaten zijn downgereguleerd in de iSPC cellen.
Genen die te maken hebben met neuron formatie waren in de iSPC cellen upreguleerd.









