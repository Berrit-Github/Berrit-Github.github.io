---
title: "Eindopdracht assesment"
subtitle: "ONECUT2 analyse"
author: "Abdurrahman Uyar en Berrit Kievith"
output: html_document
---
Bij hersenziektes zijn veel mechanismes nog niet te verklaren. Het onderzoek naar hersenen en neuronen verloopt lastig er kunnen geen cellen van gezonde mensen worden genomen om mee te vergelijken. Een oplossing hiervoor lijkt iPSCs (geïnduceerde pluripotente stamcellen). Dit zijn geïnduceerde stamcellen die kunnen worden omgezet naar hersen cellen. Helaas is dit een lang proces. daarom is het makkelijker om van fibroblasten direct naar hersen cellen te gaan. Door het aanzetten van bepaalde genen met behulp van een transcriptie factoren (TF), een van de TF die hiervoor mogelijk gebruikt kan worden is onecut. 

In dit onderzoek gaan we de onecut TF stimuleren in cellen en bekijken welke effecten dit heeft op gen expressie in vergelijking met een controle TF BCLXL.

```{r laat kwaliteit van de fastQC files zien en geef een conclussie , fig.height=3, out.width= '100%', fig.cap="Fig. 1: De gemiddelde kwaliteit van de base ligt boven de 30 op de phred score. Deze zijn dus van goede kwaliteit. De rest van de fastQC files had vergelijkbare data)" }

library(png)
library(grid)
library(gridExtra)
img1 <-  rasterGrob(as.raster(readPNG("fastQC_quality_images/quality_SRR7866699_1.png")))
img2 <-  rasterGrob(as.raster(readPNG("fastQC_quality_images/quality_seq_SRR7866699_1.png")))
grid.arrange(img1, img2, ncol=2, top=textGrob("De base qualiteit van de forward sequntie van SRR7866699 (links) en de seqentie qualiteit (rechts) . ", gp=gpar(fontsize=10,font=8)))

```

```{r maak de count tabel, eval=FALSE}

library(Rsubread)

# een vector met de locatie van de bam files
ONEcut_bam_locatie <- '/home/daur2/rnaseq/rnaseq_onecut/bam/'

# locatie waar de count tabel naar toe moet
counts_out_locatie <- "/home/berrit.kievith/daur2/eindopdracht/count_tabel/"

#maak een vector met de namen van de bam files speciefiek voor de gewilde bamfiles uit de opdracht
namen_bam_files <- list.files(ONEcut_bam_locatie, pattern = "^SRR7866(699|700|703|704).*\\.bam$", full.names = TRUE)

# maak de count tabel. specificatie over de files hieronder 
# menselijke cellen/genoom : annot.inbuilt = "hg38", 
#files zijn gepaard : isPairedEnd = true, 
#stranded protocol gebruitk : strandspecific = 1.
Onecut_counts_table <- featureCounts(
  
  files = namen_bam_files,
  annot.inbuilt = "hg38",
  useMetaFeatures = TRUE,
  strandSpecific = 1,
  isPairedEnd = TRUE, 
  countReadPairs = TRUE, 
  nthreads = 10,
  reportReadsPath = counts_out_locatie
)
??featureCounts

```

```{r DEseq2 object maken, message = FALSE , warning=FALSE}

BiocManager::install("DESeq2")
library(DESeq2)
library(tidyverse)


Onecut_counts_table <- read_rds('/home/daur2/rnaseq/rnaseq_onecut/counts/read_counts_OC2.rds')

Onecut_count_matrix <- Onecut_counts_table$counts

# daarna werd de sample data geinporteerd en naar een data frame omgezet, met rijnamen
onecut_metadata <- read_csv('/home/daur2/rnaseq/rnaseq_onecut/onecut_sampledata_OC2.csv')
onecut_metadata <- as.data.frame(onecut_metadata)
rownames(onecut_metadata) <- paste0(onecut_metadata$Run, ".bam")

# check of de namen van de countmatrix over een komen met die van de dataframe
colnames(Onecut_count_matrix) == rownames(onecut_metadata)


# er werd een kolom toegevoegd waarin iedere test conditie werd opgedeeld in ONECUT2 en BCLXL vervolgens werden deze met de factor zo ingesteld dat de BCLXL als baseline worden gebruikt en de ONECUT2 data wordt hiermee vergeleken.
onecut_metadata <- onecut_metadata %>% mutate(Behandeling = str_replace(Cell_type, "Skin derived fibroblast overexpressing Bclxl", "BCLXL")) %>% mutate(Behandeling = str_replace(Behandeling, "2 days after induction of OC2 in skin derived fibroblasts", "ONECUT2"))

onecut_metadata$Behandeling <- onecut_metadata$Behandeling %>% factor(levels = c("BCLXL", "ONECUT2"))


#de DESeq data set wordt gemaakt afgekort dds. 
Onecut_dds <- DESeqDataSetFromMatrix(
  countData = Onecut_count_matrix,
  colData = onecut_metadata, 
  design = ~ Behandeling
)

```

```{r PCA maken}

dds_nomal_onecut <- rlog(Onecut_dds)
Onecut_pca <- dds_nomal_onecut %>% assay() %>% t() %>% prcomp()

Onecut_pca_summary <- summary(Onecut_pca)$importance
Onecut_pca_plotting <- cbind(onecut_metadata, Onecut_pca$x)

```

```{r maak een bar graph met daarin de propoties van de variatie  , fig.cap="Fig. 2: de propoties van de variaties zijn hier uitgezet PC1 bevat ongeveer 95% van de variatie en PC2 3,1% PC3 en 4 zijn niet te zien in de grafiek vanwege de lage variatie"}
Onecut_bargraph <- Onecut_pca_summary %>% t()
colnames(Onecut_bargraph)[2] <- "Proportion_of_Variance"
Onecut_bargraph <- as.data.frame(Onecut_bargraph)
Onecut_bargraph <- Onecut_bargraph %>% mutate(CP = rownames(Onecut_bargraph))

Onecut_bargraph %>% ggplot() + 
  geom_col(aes( x= CP , y = Proportion_of_Variance*100, fill = CP )) +
  coord_cartesian(ylim = c(1,100)) +
  labs(title = "proporties per PC")+
  xlab("CP")+
  ylab("proportie van de variatie in %")+
  theme(legend.position = "none")

```

```{r neem de percentages van PC1 en PC2 }

# we pakken de percentages van de variatie stukken 1 en 2 
PC1_var <- round(Onecut_pca_summary["Proportion of Variance", "PC1"]*100, digits = 1)
PC2_var <- round(Onecut_pca_summary["Proportion of Variance", "PC2"]*100, digits = 1)
```

```{r plot de percentages van PC1 en PC2 tegen elkaar uit , fig.cap="Fig. 3: de ONECUT behandelde cellen worden gescheiden van de BCLXL cellen door 94,1% van de variatie daarnaast worden de cellen ook gescheiden door de 3.1% van de variatie waardoor deze scheiding is ontstaan is niet bekend"}

# vervolgens plotten we deze stukken tegen elkaar uit
ggplot(Onecut_pca_plotting) + 
  geom_point(aes(x=PC1, y=PC2, color = Behandeling ), size = 5) +
  ggtitle("PCA for ONECUT study") +
  xlab(paste0("PC1 (", PC1_var, "%)")) +
  ylab(paste0("PC2 (", PC2_var, "%)")) +
  theme_bw()
```

```{r DGE summary maken, message = FALSE}

Onecut_dge <- DESeq(Onecut_dds)
results_Onecut_dge <- results(Onecut_dge ,lfcThreshold = 1, alpha = 0.01)
summary(results_Onecut_dge)
```
In de summary is te zien hoeveel van de genen zijn upgereguleerd en hoeveel downgereguleerd, daarnaast laat het ook zien dat er geen uitbijters zijn gevonden en dat er een aantal genen zijn met low counts (hier kan in de vedere analyse rekening mee gehouden worden)

```{r volcano plot maken , fig.cap="Fig. 4: de volcano plot geeft aan welke genen een foldchange hebben van boven de de 1 hebben en die een p waarde hebben van onder de 0.01"}

oncut_volcano_plot <- data.frame(results_Onecut_dge) %>% filter(!is.na(padj))

oncut_volcano_plot <- oncut_volcano_plot %>% 
  mutate(valid = if_else(padj < 0.01 & abs(log2FoldChange)  >1 , "Significant change", "not Significant change "))

upregulated <- nrow(filter(oncut_volcano_plot, padj < 0.01 & log2FoldChange  > 1))
downregulated <- nrow(filter(oncut_volcano_plot, padj < 0.01 & log2FoldChange  <  -1))

oncut_volcano_plot %>% 
  ggplot(aes(x = log2FoldChange, y = -log10(padj), color = valid)) +
  geom_point() + 
  labs(title = "Volcano plot van de significante genen") +
  xlab("log2 fold change") +
  ylab("-log10 adjusted p-value") + 
  theme_bw() + scale_colour_manual(values = c("grey", "darkorange"), name = "Significance")+
  geom_hline(yintercept = -log10(0.01), linetype = "dashed")+
  geom_vline(xintercept =  1, linetype = "dashed")+
   geom_vline(xintercept =  -1, linetype = "dashed")+
   annotate("text", x = 10, y = 225, size=2.5,
           label = paste(upregulated , "upregulated genes")) +
  annotate("text", x = -5, y = 225, size=2.5,
           label = paste(downregulated , "downregulated genes"))

```

```{r heatmap met de 5 up en down genen met SYMBOL namen, message = FALSE , warning=FALSE , fig.cap="Fig. 5: De heatmap laat zien dat de genen van de cellen die behandeld zijn zijn upgereuleerd hieronder is ook ONECUT zelf te zien. daarnaast is ook te zien welke genen er zijn downgereguleerd."}
library(pheatmap)
BiocManager::install("org.Hs.eg.db")
library("org.Hs.eg.db")


# pak de namen van de 5 meest up en downgereuleerde genen

new_results_pls <- as.data.frame(results_Onecut_dge)
top5up_genes <- filter(new_results_pls, padj < 0.01 & log2FoldChange  > 1)
top5up_genes <- rownames(top5up_genes[order(top5up_genes$log2FoldChange, decreasing=TRUE )[1:5],])

top5down_genes <- filter(new_results_pls, padj < 0.01 & log2FoldChange  < -1)
top5down_genes <- rownames(top5down_genes[order(top5down_genes$log2FoldChange )[1:5],])

# Neem van deze namen de countvalues
count_values_top5upgenes <- assay(Onecut_dds)[top5up_genes,]
count_values_top5downgenes <- assay(Onecut_dds)[top5down_genes,]
                                  
#  voeg de tabelen samen en vervang de de rijnamen door de bijbehorende gen symbolen en vervang de kolom namen voor behandelings methode uit de metadata 
new_values <- rbind(count_values_top5upgenes, count_values_top5downgenes)
new_values <- new_values %>% data.frame()
new_values_names<- new_values %>% mutate( entrized = rownames(new_values))

new_values_names$symbol <- mapIds(org.Hs.eg.db,
                                    keys = new_values_names$entrized,
                                    column = "SYMBOL",
                                    keytype = "ENTREZID",
                                    multiVals = "first")

rownames(new_values) <- new_values_names$symbol
colnames(new_values) <- onecut_metadata$Behandeling

# Bekijk de resultaten in de heatmap
pheatmap(new_values, show_rownames = TRUE, scale = "row", angle_col = 0)

```

```{r functie voor het vinden van genen op chromosomen banden , message = FALSE}

# met deze functie kunnen de genen die op een specifieke chromosoomband liggen gevonden worden
cytoband <- function(band){

genen <- mapIds(org.Hs.eg.db,
                                       keys = band,
                                       column = "ENTREZID",
                                       keytype = "MAP",
                                       multiVals = "list")
Vector <- NULL

for( gen in genen){
  Vector <- append(Vector,gen)
}
Vector

}

```

```{r top 20 up en down gereguleerde genen en hun bijbhorende GO terms in een grafiek uitplotten , message = FALSE , fig.cap="Fig. 6:(links) De grafiek geeft aan welke genen zijn upgereguleerd in fibroblasten die behandeld zijn met ONECUT. (Rechts) De grafiek geeft aan welke genen zijn downgereguleerd in fibroblasten die behandeld zijn met ONECUT.  ", fig.show="hold", out.width="50%"}
 
library(GOstats)
library(GO.db)
all_names <- results_Onecut_dge %>% data.frame() %>% rownames()

#De upgereguleerde grafiek met GOterms
oncut_upregultated_GO <- results_Onecut_dge %>% data.frame() %>% filter(log2FoldChange > 1 , padj < 0.01) %>% rownames()
      
 GO_term_up_new <- methods::new("GOHyperGParams",
                     geneIds = oncut_upregultated_GO,
                     universeGeneIds = all_names, 
                     annotation = "org.Hs.eg.db", 
                     ontology = "BP", 
                     pvalueCutoff = 1,
                     testDirection = "over")
  goterm_up_analysis <- hyperGTest(GO_term_up_new)
  summary_up_analysis <- summary(goterm_up_analysis)


summary_up_analysis$padj <- p.adjust(summary_up_analysis$Pvalue, method = "BH")

summary_up_analysis <- summary_up_analysis %>% filter(Count > 5) %>% filter(Count < 500)


goterm_analysis_up20 <- summary_up_analysis[order(summary_up_analysis$padj)[1:20],]

goterm_analysis_up20$Term <- factor(goterm_analysis_up20$Term, 
                                     levels = goterm_analysis_up20$Term[
                                       order(goterm_analysis_up20$padj, decreasing = TRUE)])


goterm_analysis_up20 %>% ggplot(aes(x = Term, y = -log10(padj))) +
  geom_point() +
  coord_flip() +
  ylab("-log[10](adjusted P-value)") + 
  xlab("GO terms") +
  ggtitle(" top 20 upregulated genes with GO terms") +
  theme_bw()

#downgereguleerde grafiek met GO terms

oncut_downregultated_GO <- results_Onecut_dge %>% data.frame() %>% filter(log2FoldChange < -1 , padj < 0.01) %>%rownames()
GO_down <- methods::new("GOHyperGParams",
                     geneIds = oncut_downregultated_GO,
                     universeGeneIds = all_names, 
                     annotation = "org.Hs.eg.db", 
                     ontology = "BP", 
                     pvalueCutoff = 1,
                     testDirection = "over")

goterm_analysis_down <- hyperGTest(GO_down)
  
summary_down_analysis <- summary(goterm_analysis_down)
summary_down_analysis$padj <- p.adjust(summary_down_analysis$Pvalue, method = "BH")

summary_down_analysis <- summary_down_analysis %>% filter(Count > 5) %>% filter(Count < 500)

goterm_analysis_down20 <- summary_down_analysis[order(summary_down_analysis$padj)[1:20],]
goterm_analysis_down20$Term <- factor(goterm_analysis_down20$Term, 
                                     levels = goterm_analysis_down20$Term[
                                       order(goterm_analysis_down20$padj, decreasing = TRUE)])

goterm_analysis_down20 %>% ggplot(aes(x = Term, y = -log10(padj))) +
  geom_point() +
  coord_flip() +
  ylab("-log10(adjusted P-value)") + 
  xlab("GO terms") +
  ggtitle(" top 20 downregulated genes with GO terms") +
  theme_bw()
  

```

Go term nervous system development heeft de meest significante P-waarde in de upgereguleerde analyse. Ook hebben genen die te maken hebben met cel-cel signalering en cel differentiatie een verhoogde expressie. 

Bij de downregulatie analyse veel termen die te maken hebben met cel migratie. 

Ten slotte als we kijken dat de er meer nevous system develpment is en dat de cellen meer met elkaar signaleren in combinatie met dat ze minder migreren is een aanwijzing dat de cellen meer kenmerken van hersen cellen vertonen. 



_Bronvermelding_
_De data en code uit deze analyse zijn gebaseerd op de DAUR2 Reader van canvas_

